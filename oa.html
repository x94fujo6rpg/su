<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width" />
    <title>OA</title>
</head>

<body>
    OA
</body>
<script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-auth.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDW8RQcC6kjicXm1otJ4vbtyzZXovy7OM8",
        authDomain: "azur-lane-fleet-tool.firebaseapp.com",
        projectId: "azur-lane-fleet-tool",
        storageBucket: "azur-lane-fleet-tool.appspot.com",
        messagingSenderId: "83250372184",
        appId: "1:83250372184:web:d91e16ad0e55900b3f342d",
        measurementId: "G-EWKSWT1DBM"
    };
    firebase.initializeApp(firebaseConfig);
</script>

<script>
    (async() => {
        const
            pars = new URLSearchParams(window.location.search),
            url = pars.get('url');
        let user_name = window.location.host.match(/(.*)\.github\.io/);

        if (user_name) {
            user_name = user_name[1];
        }

        if (!user_name) {
            console.log("unable to get username abort");
            return;
        }

        if (url) {
            let token = await get_token_firebase();
            if (!token) {
                throw Error("unable to get github token");
            } else {
                url = decodeURIComponent(url);
                await create_issue(token, url);
            }
        }

        async function get_token_firebase() {
            const providerGithub = new firebase.auth.GithubAuthProvider();
            try {
                let result = await firebase.auth().signInWithPopup(providerGithub),
                    credential = result.credential,
                    token = credential.accessToken,
                    user = result.user;
                console.log({
                    credential,
                    token,
                    user,
                });
                return {
                    credential,
                    token,
                    user,
                };
            } catch (error) {
                let {
                    code,
                    message,
                    email,
                    credential
                } = error;
                console.log({
                    code,
                    message,
                    email,
                    credential
                });
                return false;
            }
        }

        async function create_issue(token, url) {
            const target_repo_name = "su-db",
                api_url = `https://api.github.com/repos/${user_name}/${target_repo_name}/issues`;
            let headers = new Headers({
                    "Accept": "application/vnd.github.v3+json",
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json",
                }),
                issue = {
                    title: url, // issue title
                    body: "this is create by app",
                    assignees: [],
                    labels: [],
                    milestone: null,
                },
                config = {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify(issue),
                    redirect: "follow",
                };

            fetch(api_url, config)
                .then(res => res.json())
                .then(result => console.log(result))
                .catch(error => console.log('error', error));
        }
    })();
</script>

</html>